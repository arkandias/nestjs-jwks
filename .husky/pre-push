#!/bin/sh
#
# Git pre-push hook: Version Tag Validation
#
# Validates that version tags (v1.2.3 format) match the version in package.json.
#
# This prevents accidentally pushing tags that don't match the declared version
# in the package.json.
#
# Usage: Automatically runs when pushing tags to remote
# Pattern: ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-z0-9.]+)?$
#

# Exit the script immediately if any command fails
set -e

# Version tag pattern: v[major].[minor].[patch][-prerelease]
VERSION_TAG_PATTERN='v[0-9][0-9]*\.[0-9][0-9]*\.[0-9][0-9]*\(-[a-z0-9.][a-z0-9.]*\)*$'
readonly VERSION_TAG_PATTERN

# Read each ref being pushed from stdin
while read -r local_ref local_sha _ _; do

    # Check if this is a tag push
    case "${local_ref}" in
    refs/tags/*)
        tag_name="$(basename "${local_ref}")"

        # Check if tag matches version pattern
        if expr "${tag_name}" : "${VERSION_TAG_PATTERN}" >/dev/null; then
            echo "Tag version check..."

            # Extract version without 'v' prefix
            version_from_tag=$(echo "${tag_name}" | sed 's/^v//')

            # Read package.json version from the commit being tagged
            if ! package_json=$(git show "${local_sha}:package.json" 2>/dev/null); then
                echo "✗ package.json not found in commit ${local_sha}"
                exit 1
            fi

            # Extract version from package.json using grep and sed
            version_from_package=$(echo "${package_json}" | grep '"version":' | sed 's/.*"version": *"\([^"]*\)".*/\1/')

            if [ -z "${version_from_package}" ]; then
                echo "✗ Could not extract version from package.json"
                exit 1
            fi

            # Compare versions
            if [ "${version_from_tag}" != "${version_from_package}" ]; then
                echo "✗ Version mismatch!"
                echo "  Tag version: ${version_from_tag}"
                echo "  package.json version: ${version_from_package}"
                exit 1
            fi

            echo "✓ Version validated: ${version_from_tag}"
        fi
        ;;
    esac
done
